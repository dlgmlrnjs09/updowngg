<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="gg.updown.backend.main.api.review.mapper.ReviewMapper">

    <resultMap id="reviewWithTagsMap" type="reviewDto">
        <!-- review 테이블의 컬럼들 매핑 -->
        <id property="summonerReviewSeq" column="summoner_review_seq"/>
        <result property="reviewerSiteCode" column="reviewer_site_code"/>
        <result property="reviewerPuuid" column="reviewer_puuid"/>
        <result property="targetPuuid" column="target_puuid"/>
        <result property="skillRating" column="skill_rating"/>
        <result property="teamworkRating" column="teamwork_rating"/>
        <result property="mannerRating" column="manner_rating"/>
        <result property="comment" column="comment"/>
        <result property="regDt" column="reg_dt"/>
        <result property="updDt" column="upd_dt"/>
        <result property="delDt" column="del_dt"/>

        <!-- tag_code들을 List<String>으로 매핑 -->
        <collection property="tagCodeList" ofType="string" javaType="list">
            <result column="tag_code"/>
        </collection>
    </resultMap>

    <select id="getWroteReviewList" parameterType="String" resultMap="reviewWithTagsMap">
        SELECT
            r.summoner_review_seq,
            reviewer_site_code,
            reviewer_puuid,
            target_puuid,
            skill_rating,
            teamwork_rating,
            manner_rating,
            comment,
            reg_dt,
            upd_dt,
            del_dt,
            t.tag_code
        FROM
            site_summoner_review r
            LEFT JOIN site_summoner_review_tag t ON r.summoner_review_seq = t.summoner_review_seq
        WHERE
            reviewer_puuid = #{reviewerPuuid}
          and del_dt IS NULL
    </select>

    <select id="getReviewTagList" parameterType="String">
        SELECT
            tag_code,
            tag_value,
            tag_description
        FROM
            site_review_tag
    </select>

    <!-- 리뷰 등록 -->
    <insert id="insertReview" parameterType="ReviewSubmitReqDto" useGeneratedKeys="true" keyProperty="summonerReviewSeq">
        INSERT INTO site_summoner_review (
            reviewer_site_code,
            reviewer_puuid,
            target_puuid,
            skill_rating,
            teamwork_rating,
            manner_rating,
            comment
        ) VALUES (
             #{reviewerSiteCode},
             #{reviewerPuuid},
             #{targetPuuid},
             #{skillRating},
             #{teamworkRating},
             #{mannerRating},
             #{comment}
         )
    </insert>

    <!-- 리뷰 태그 등록 -->
    <insert id="insertReviewTags" parameterType="java.util.Map">
        INSERT INTO site_summoner_review_tag (
        summoner_review_seq,
        tag_code
        ) VALUES
        <foreach collection="tagCodeList" item="tagCode" separator=",">
            (#{reviewSeq}, #{tagCode})
        </foreach>
    </insert>

    <delete id="deleteReviewTags" parameterType="Long">
        DELETE FROM site_summoner_review_tag WHERE summoner_review_seq = #{reviewSeq}
    </delete>

    <update id="updateReview" parameterType="ReviewSubmitReqDto">
        UPDATE site_summoner_review
        SET skill_rating = #{skillRating}
            , teamwork_rating = #{teamworkRating}
            , manner_rating = #{mannerRating}
            , comment = #{comment}
        WHERE
            summoner_review_seq = #{summonerReviewSeq}
    </update>

    <select id="getReviewStatus" parameterType="String" resultType="reviewStatsDto">
        SELECT
            target_puuid as puuid,
            ROUND(AVG(skill_rating), 1) AS skillRatingAvg,
            ROUND(AVG(teamwork_rating), 1) AS teamworkRatingAvg,
            ROUND(AVG(manner_rating), 1) AS mannerRatingAvg,
            COUNT(*) AS totalReviewCnt,
            COUNT(CASE WHEN reg_dt >= CURRENT_TIMESTAMP - INTERVAL '30 days' THEN 1 END) AS last30DayReviewCnt
        FROM site_summoner_review
        where target_puuid = #{targetPuuid}
          and del_dt is NULL
        group by target_puuid
    </select>
</mapper>

